<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sources Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="https://convertico.com/images/1750456354.0556/Untitled.ico" type="image/x-icon">
<style id="theme-style"></style>
<style>
  :root {
    --bg: #f0f0f0;
    --fg: #222;
    --card-bg: #fff;
    --input-bg: #fff;
    --border: #ccc;
    --accent: #2980b9;
  }
  [data-theme="dark"] {
    --bg: #121212;
    --fg: #eee;
    --card-bg: #1e1e1e;
    --input-bg: #333;
    --border: #555;
    --accent: #4ea1ff;
  }
  body {
    background: var(--bg);
    color: var(--fg);
    font-family: 'Segoe UI', Tahoma, sans-serif;
    padding: 20px;
    transition: background 0.4s, color 0.4s;
  }
  h1 {
    text-align: center;
    margin-top: 0;
  }
  textarea, input[type="text"] {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--input-bg);
    color: var(--fg);
    box-sizing: border-box;
  }
  button {
    background-color: var(--accent);
    color: white;
    border: none;
    padding: 10px 18px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    margin: 5px;
  }
  button:hover {
    background-color: #1f6391;
  }
  .top-bar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 10px;
  }
  .theme-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
  }
  .theme-switch input { display: none; }
  .slider {
    position: absolute;
    cursor: pointer;
    background-color: #ccc;
    border-radius: 34px;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    transition: .4s;
  }
  .slider:before {
    content: "";
    position: absolute;
    height: 22px;
    width: 22px;
    left: 2px;
    top: 2px;
    background: white url('https://cdn-icons-png.flaticon.com/512/169/169367.png') center/16px no-repeat;
    border-radius: 50%;
    transition: .4s;
  }
  input:checked + .slider {
    background-color: var(--accent);
  }
  input:checked + .slider:before {
    transform: translateX(24px);
    background-image: url('https://cdn-icons-png.flaticon.com/512/1164/1164954.png');
  }
  .table-view table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid var(--border);
    background: var(--card-bg);
  }
  img.icon {
    width: 24px;
    height: 24px;
    border-radius: 4px;
    margin-right: 6px;
    vertical-align: middle;
  }
  .card-view { display: none; }
  .app-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .app-card h3 {
    margin: 0 0 5px;
  }
  .copy-btn {
    margin-left: 5px;
    font-size: 13px;
    padding: 6px 10px;
    background-color: #888;
    color: white;
    border: none;
    border-radius: 4px;
  }
  .copy-btn:hover {
    background-color: #666;
  }
  .button-group {
    text-align: center;
    margin-bottom: 10px;
  }
  @media (max-width: 768px) {
    .table-view { display: none; }
    .card-view { display: block; }
    img.icon, .app-card img { width: 20px; height: 20px; }
  }
</style>
</head>
<body>

<div class="top-bar">
  <label class="theme-switch">
    <input type="checkbox" id="themeToggle">
    <span class="slider"></span>
  </label>
</div>

<h1>ðŸ“² Sources Viewer</h1>

<textarea id="sources" placeholder="Paste your source URLs here, one per line..."></textarea>
<div class="button-group">
  <button onclick="fetchSources()">Load Apps</button>
  <button onclick="pasteFromClipboard()">ðŸ“‹ Paste Link</button>
</div>

<input type="text" id="search" placeholder="Search apps by name..." oninput="filterApps()">

<div class="table-view">
  <table id="appsTable" style="display:none;">
    <thead>
      <tr>
        <th>App</th>
        <th>Description</th>
        <th>Version</th>
        <th>Date</th>
        <th>Size</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div class="card-view" id="cardContainer"></div>

<script>
const toggle = document.getElementById('themeToggle');
if (localStorage.theme === 'dark') {
  document.documentElement.setAttribute('data-theme', 'dark');
  toggle.checked = true;
}
toggle.addEventListener('change', () => {
  if (toggle.checked) {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.theme = 'dark';
  } else {
    document.documentElement.setAttribute('data-theme', 'light');
    localStorage.theme = 'light';
  }
});

let fullAppList = [];
async function fetchSources() {
  const sources = document.getElementById("sources").value.trim().split("\n");
  const tbody = document.getElementById("tableBody");
  const cardContainer = document.getElementById("cardContainer");
  tbody.innerHTML = '';
  cardContainer.innerHTML = '';
  document.getElementById("appsTable").style.display = 'none';
  fullAppList = [];
  for (let url of sources) {
    url = url.trim().replace(/\/+$/, '');
    try {
      const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(url);
      const res = await fetch(proxyUrl);
      const data = await res.json();
      const apps = Array.isArray(data) ? data : (data.apps || []);
      fullAppList.push(...apps);
    } catch (e) {
      alert(`Failed to load source: ${url}`);
    }
  }
  renderApps(fullAppList);
}

function renderApps(apps) {
  const tbody = document.getElementById("tableBody");
  const cardContainer = document.getElementById("cardContainer");
  tbody.innerHTML = '';
  cardContainer.innerHTML = '';
  apps.forEach(app => {
    const downloadLink = app.url || app.downloadURL || null;
    const iconURL = app.iconURL || app.icon || '';
    const description = app.localizedDescription || '-';
    const appName = app.name || '-';
    const row = document.createElement("tr");
    row.setAttribute("data-app-name", appName.toLowerCase());
    row.innerHTML = `<td>${iconURL ? createSafeImage(iconURL).outerHTML : ''} ${appName}</td>
      <td>${description}</td><td>${app.version || '-'}</td><td>${app.versionDate || '-'}</td>
      <td class="size-cell">Checking...</td>
      <td>${downloadLink ? `<a href="${downloadLink}" target="_blank">Download</a><button class="copy-btn" onclick="copyLink('${downloadLink}')">Copy Link</button>` : '<span style="color: gray;">Unavailable</span>'}</td>`;
    tbody.appendChild(row);
    if (downloadLink) getFileSize(downloadLink).then(size => row.querySelector('.size-cell').textContent = size);
    const card = document.createElement("div");
    card.className = "app-card";
    card.setAttribute("data-app-name", appName.toLowerCase());
    card.innerHTML = `<h3>${iconURL ? createSafeImage(iconURL).outerHTML : ''}${appName}</h3>
      <p><strong>Description:</strong> ${description}</p>
      <p><strong>Version:</strong> ${app.version || '-'}</p>
      <p><strong>Date:</strong> ${app.versionDate || '-'}</p>
      <p><strong>Size:</strong> <span class="size-text">Checking...</span></p>
      <p><strong>Download:</strong> ${downloadLink ? `<a href="${downloadLink}" target="_blank">Download</a><button class="copy-btn" onclick="copyLink('${downloadLink}')">Copy Link</button>` : '<span style="color: gray;">Unavailable</span>'}</p>`;
    cardContainer.appendChild(card);
    if (downloadLink) getFileSize(downloadLink).then(size => card.querySelector('.size-text').textContent = size);
  });
  if (apps.length) document.getElementById("appsTable").style.display = 'table';
}

function filterApps() {
  const query = document.getElementById("search").value.trim().toLowerCase();
  document.querySelectorAll("#tableBody tr").forEach(row => row.style.display = row.getAttribute("data-app-name").includes(query) ? '' : 'none');
  document.querySelectorAll(".app-card").forEach(card => card.style.display = card.getAttribute("data-app-name").includes(query) ? '' : 'none');
}

function copyLink(link) {
  navigator.clipboard.writeText(link).then(() => alert("Link copied!"));
}

async function pasteFromClipboard() {
  try {
    document.getElementById("sources").value = await navigator.clipboard.readText();
  } catch {
    alert("Failed to read from clipboard.");
  }
}

function createSafeImage(url) {
  const img = document.createElement('img');
  img.src = url;
  img.className = "icon";
  img.onerror = () => img.src = "https://via.placeholder.com/24?text=ðŸ“±";
  return img;
}

async function getFileSize(url) {
  try {
    const proxy = "https://sources-viewer.mostafa3098x.workers.dev/?url=" + encodeURIComponent(url);
    const res = await fetch(proxy);
    const size = await res.text();
    if (!size || isNaN(size)) return "N/A";
    const kb = Number(size) / 1024;
    return kb > 1024 ? (kb / 1024).toFixed(2) + " MB" : kb.toFixed(1) + " KB";
  } catch {
    return "N/A";
  }
}
</script>
</body>
</html>
