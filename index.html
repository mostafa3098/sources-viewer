<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sources Viewer</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <script>
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
    }
  </script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    .dark body {
      background-color: #121212;
      color: #eee;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    .title {
      text-align: center;
      font-size: 2rem;
      margin-top: 20px;
    }
    .theme-toggle {
      position: absolute;
      top: 15px;
      right: 20px;
      cursor: pointer;
      font-size: 1.5rem;
    }
    .input-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    input[type="text"] {
      width: 70%;
      padding: 10px;
      font-size: 1rem;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    .app-card {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      background: #fff;
      transition: background 0.3s;
    }
    .dark .app-card {
      background: #1e1e1e;
      border-color: #444;
    }
    .app-header {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .app-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
    }
    .app-info {
      flex-grow: 1;
    }
    .app-name {
      font-size: 1.2rem;
      font-weight: bold;
    }
    .app-desc {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .app-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .download-actions {
      display: flex;
      gap: 10px;
    }
    @media (max-width: 600px) {
      .download-actions {
        flex-direction: row;
        justify-content: flex-end;
      }
      .app-footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="theme-toggle" onclick="toggleTheme()">ðŸŒ—</div>
  <div class="container">
    <h1 class="title">ðŸ“² Sources Viewer</h1>
    <div class="input-group">
      <button onclick="pasteSource()">Paste</button>
      <input type="text" id="sourceInput" placeholder="Enter source URL...">
      <button onclick="loadSources()">Load Apps</button>
    </div>
    <div id="apps"></div>
  </div>

  <script>
    function toggleTheme() {
      const root = document.documentElement;
      root.classList.toggle("dark");
      const newTheme = root.classList.contains("dark") ? "dark" : "light";
      localStorage.setItem("theme", newTheme);
    }

    async function pasteSource() {
      try {
        const text = await navigator.clipboard.readText();
        document.getElementById("sourceInput").value = text;
      } catch (err) {
        alert("Clipboard access denied");
      }
    }

    async function loadSources() {
      const url = document.getElementById("sourceInput").value;
      if (!url) return;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const appsDiv = document.getElementById("apps");
        appsDiv.innerHTML = "";

        const sourceName = url.split("/").slice(-2, -1)[0];

        data.forEach(app => {
          const card = document.createElement("div");
          card.className = "app-card";

          const icon = document.createElement("img");
          icon.src = app.iconURL;
          icon.className = "app-icon";

          const name = document.createElement("div");
          name.className = "app-name";
          name.textContent = app.name;

          const desc = document.createElement("div");
          desc.className = "app-desc";
          desc.textContent = app.localizedDescription || "";

          const info = document.createElement("div");
          info.className = "app-info";
          info.appendChild(name);
          info.appendChild(desc);

          const header = document.createElement("div");
          header.className = "app-header";
          header.appendChild(icon);
          header.appendChild(info);

          const footer = document.createElement("div");
          footer.className = "app-footer";

          const size = document.createElement("div");
          size.textContent = "Loading...";

          getFileSize(app.downloadURL).then(s => size.textContent = s);

          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = "Download";
          downloadBtn.onclick = () => window.open(app.downloadURL);

          const copyBtn = document.createElement("button");
          copyBtn.textContent = "Copy Link";
          copyBtn.onclick = () => navigator.clipboard.writeText(app.downloadURL);

          const actions = document.createElement("div");
          actions.className = "download-actions";
          actions.appendChild(downloadBtn);
          actions.appendChild(copyBtn);

          footer.appendChild(size);
          footer.appendChild(actions);

          card.appendChild(header);
          card.appendChild(footer);

          const sourceLabel = document.createElement("div");
          sourceLabel.style.fontSize = "0.8rem";
          sourceLabel.style.opacity = "0.7";
          sourceLabel.textContent = `Source: ${sourceName}`;
          card.appendChild(sourceLabel);

          appsDiv.appendChild(card);
        });
      } catch (err) {
        alert("Failed to load source.");
      }
    }

    async function getFileSize(url) {
      try {
        const encoded = encodeURIComponent(url);
        const proxy = "https://sources-viewer.mostafa3098x.workers.dev/?url=" + encoded;
        const res = await fetch(proxy);
        const size = await res.text();

        if (!size || isNaN(size)) return "N/A";

        const kb = Number(size) / 1024;
        return kb > 1024
          ? (kb / 1024).toFixed(2) + " MB"
          : kb.toFixed(1) + " KB";
      } catch {
        return "N/A";
      }
    }
  </script>
</body>
</html>